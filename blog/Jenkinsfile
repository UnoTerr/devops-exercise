node { 
    def app

    stage('Checkout code') {
        checkout scm
    }

    stage('Build image') {
        app = docker.build("unoterr1/blog_pipe", "-f blog/Dockerfile .")
        //sh 'ls'
        //sh 'cd blog && docker-compose up --build'
    }
    
    stage('Deploy 1') {
      //  sh 'kubectl delete pods postgresql redis traefik lol'
      //  sh 'kubectl run postgresql --image=postgresql:latest'
      //  sh 'kubectl run redis --image=redis:latest'
      //  sh 'kubectl run traefik --image=traefik:latest'
    }

    stage('Test image') {
        //app.inside {
            sh 'echo "Tests passed"'
    //    }
    }
           
    stage('Push Hub') {
        docker.withRegistry('https://registry.hub.docker.com/', 'hub') {           
            app.push("${env.BUILD_NUMBER}")            
            app.push("latest")        
            }    
        }

    stage('Deploy App') {
        sh 'cd blog && kubectl apply -f db.yaml'
        sh 'cd blog && kubectl apply -f blog.yaml'
 //       sh 'cd blog && kubectl apply -f service_db.yaml'
 //       sh 'cd blog && kubectl apply -f service_blog.yaml'
    }
}
/*
    stage("Push image") {
        sh 'cd blog && kubectl apply -f DeployKube.yaml'
        sh 'cd blog && kubectl apply -f db.yaml'
        sh 'echo "Deployed!"'
    }

/*
    stage("Push image") {
                script {
                    docker.withRegistry('https://registry.hub.docker.com', 'dockerhub') {
                            myapp.push("latest")
   //                         myapp.push("${env.BUILD_ID}")
                    }
        }

    stage('Deploy App') {
        kubernetesDeploy(configs: "hellowhale.yml", kubeconfigId: "mykubeconfig")
    }
*/
